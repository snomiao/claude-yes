# Minimal Alpine-based image for agent-yes
# Size: ~200-400MB vs 2.2GB for full image

# Build stage - includes all build tools and dependencies
FROM node:alpine AS builder

# Install build tools and bun
RUN apk add --no-cache \
    bash \
    git \
    curl \
    build-base \
    python3 \
    && curl -fsSL https://bun.sh/install | bash \
    && ln -s /root/.bun/bin/bun /usr/local/bin/bun

# Install and build project
WORKDIR /src/agent-yes
COPY package.json bun.lock ./
# Install all dependencies (including dev deps needed for build)
# Use --ignore-scripts to prevent prepare script from running before source is copied
RUN bun install --ignore-scripts && bun pm cache clean

# Copy source and build
COPY . .
RUN bun run build

# Runtime stage - minimal runtime environment
FROM node:alpine

# Install runtime dependencies and temporary build tools
RUN apk add --no-cache \
    bash \
    git \
    curl \
    build-base \
    python3 \
    && curl -fsSL https://bun.sh/install | bash \
    && ln -s /root/.bun/bin/bun /usr/local/bin/bun

# Copy built application from builder
WORKDIR /src/agent-yes
COPY --from=builder /src/agent-yes/dist ./dist
COPY --from=builder /src/agent-yes/package.json ./
COPY --from=builder /src/agent-yes/bun.lock ./

# Install only production dependencies and build native modules
RUN bun install --production --ignore-scripts && npm rebuild node-pty && bun pm cache clean

# Remove build tools to save space
RUN apk del build-base python3

# Link agent-yes globally
RUN bun link

# Set working directory for user workspace
WORKDIR /ws

# Use node to run agent-yes
ENTRYPOINT ["node", "/src/agent-yes/dist/agent-yes.js"]

# Note: This minimal image does NOT include:
# - Rust toolchain
# - Python3 and build tools
# - AI agent CLIs (claude-code, qwen-code, etc.)
#
# Documentation is available in the GitHub repo:
# - Environment info: https://github.com/snomiao/agent-yes/blob/main/ws/AGENTS.md
# - Setup guide: https://github.com/snomiao/agent-yes/blob/main/ws/SETUP.md
